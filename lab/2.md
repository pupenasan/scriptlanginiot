[Лабораторні](README.md)

# ЛАБОРАТОРНА РОБОТА № 2. Програмування IoT шлюзів з використанням Node.js

## Підготовка IoT Gateway

### Створення віртуальної машини

- [ ] Встановіть віртуальну машину, як це описано [за посиланням](https://asu-in-ua.github.io/atpv/vm/vbox/lablinuxdesktop.html)
- [ ] Налаштуйте мережний адаптер віртуальної машини, щоб він був підключений до мережної карти, через яку Ви з'єднуєтеся з Інтернет. Даний спосіб дасть Вам можливість використовувати комунікацію ВМ як для Інтернет так і для зв'язку з хостовою ОС.   

![image-20231229134659698](media2/image-20231229134659698.png)

- [ ] Запустіть віртуальну машину. Залогуйтеся в консолі і наберіть `ping 8.8.8.8` щоб впевнитися що є зв'язок з Інтернетом. Вихід з режиму ping через `Ctrl + C`.
- [ ]  Отримайте інформацію про отриману IP-адресу

```
hostname -I
```

- [ ] Встановіть Uncomplicated Firewal

```
sudo apt install ufw
```

### Встановлення необхідних утиліт для роботи з віддаленою машиною

- [ ] Завантажте Putty для своєї версії ОС за посиланням https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html . Ця утиліта дає можливість підключатися до різноманітних пристроїв в термінальному режимі.
- [ ] Запустіть `Putty`. У полі `Host Name`  впишіть IP адресу віртуальної машини з Debian, яку Ви отримали у попередньому пункті. У полі `Saved Session` впишіть назву підключення, наприклад `Debian`, через яке Ви зможете підключатися пізніше, зробивши вибір, і натисніть `Save`. Після цього натисніть `Open` щоб відкрити сессію.   

![image-20231229153853736](media2/image-20231229153853736.png)

- [ ] Перший раз при підключенні, Putty зробить попередження, натисніть `Accept` щоб погодитися.

![image-20231229153353676](media2/image-20231229153353676.png)

- [ ] Відкриється вікно терміналу, аналогічне тому, яке показується при роботі з віртуальною машиною. 

![image-20231229154416141](media2/image-20231229154416141.png)

Надалі усі дії з віртуальною машиною можна робити як через вікно машини так і через термінал Putty. Термінал працює з використанням захищеного протоколу `ssh`. При підключенні до реального пристрою з Linux, Putty дає можливість працювати в командному режимі. 

- [ ] Звантажте та встановіть WinSCP https://sourceforge.net/projects/winscp/ . Цей застосунок дає можливість підключатися до файлової системи ОС Linux через SSH та інші способи комунікації
- [ ] Запустіть WinSCP на виконання. У полі `Depjk`  впишіть IP адресу віртуальної машини з Debian, яку Ви отримали у попередньому пункті. У полях `login`  і`пароль` впишіть відповідно ім'я користувача і пароль, а збережіть налаштування за допомогою кнопки `зберегти`, щоб потім Ви змогли підключатися пізніше, зробивши вибір. Після цього натисніть `Login` щоб відкрити сесію.   

![image-20231229165738585](media2/image-20231229165738585.png)

- [ ] Перший раз при підключенні як і випадку з Putty, вийде попередження, натисніть `Accept` щоб погодитися. Відкриється навігатор, в якому перейдіть на верхній рівень в кореневу директорію.

![image-20231229165954453](media2/image-20231229165954453.png)

- [ ] Встановіть текстовий редактор Notepad++ https://notepad-plus-plus.org/



### Встановлення Node.js на віртуальну машину

- [ ] Запустіть віртуальну машину.
- [ ] Залогуйтеся в системі, після чого введіть

```
sudo apt update
```

повторно введіть пароль амінітсратора, для продовження операції.

- [ ] Запустіть інсталятор `nodejs`

```
sudo apt install nodejs
```

натисніть `y`  на пропозицію встановлення

- [ ] Перевірте версію встановленого `nodejs`

```
node -v
```

- [ ] Встановіть пакунок `npm`

```
sudo apt install npm
```

- [ ] Перевірте версію встановленого npm

```
npm -v
```

## Створення проекту Node.js 

### Створення папки проекту та ініціалізація 

- [ ] У консолі віртуальної машини створіть папку для проекту

```
mkdir nodejsprj
```

- [ ] Перейдіть в цю папку

```
cd nodejsprj
```

- [ ] Зробіть ініціювання проекту node.js

```
npm init -y
```

Після цього з'явиться повідомлення в яке виводиться файл `package.json`

![image-20231230130216669](media2/image-20231230130216669.png)

- [ ] Запустіть WinSCP, підключіться до віртуальної машини
- [ ] Перейдіть в новостворену папку `nodejsprj` . Ви повинні побачити там `package.json`

### Створення та перевірка простої програми 

- [ ] Налаштуйте щоб усі файли за замовченням відкривалися в текстовому редакторі `Notepad++`, для цього зайдіть в `Опції->Налаштування` в вкажіть цю програму, а також виставте опцію `Примусова текстова передача файлів для зовнішнього редактора`, після чого натисніть `Ok`

![image-20231230141530121](media2/image-20231230141530121.png)

- [ ] У папці `nodejsprj` створіть файл `index.js` 

![image-20231230141152262](media2/image-20231230141152262.png)

Відкриється редактор `Notepad++` . 

- [ ] Запишіть фрагмент програми і збережіть її.

```js
console.log ('Hello world!')
```

- [ ] У консолі Debian ВМ наберіть команду `node index`, має вивести повідомлення 'Hello world!'

### Встановлення пакунку nodemon 

Пакунок `nodemon` дає можливість змінювати програму в середовищі виконання  без зупинки та повторного запуску. Цей пакунок відноситься до середовищ розроблення.   

- [ ] У терміналі Debian в папці проекту наберіть `npm install nodemon -D` та натисніть Enter. 

Команда `install` встановлює потрібний пакунок, а опція  `-D` вказує на те, що цей пакунок потрібен тільки в середовищі розроблення для налагодження застосунку. 

У результаті виконання команди менеджер npm завантажує необхідний пакунок з репозиторію, розпаковує його у вашу папку і встановлює залежності в:

- файл  package.json
- новостворений файл package-lock.json
- [ ] Використовуючи WinSCP подивіться на зміст папки проекту (кнопка `Refresh` оновлює зміст): там повинна з'явитися папка `node_modules` та міститися два файли json.
- [ ] Подивіться на зміст файлу  `package.json`: там повинен з'явитися розділ `devDependencies` у якому є назва встановленого пакунку. Тепер він використовується в проекті для середовища розроблення.
- [ ] Подивіться на зміст файлу  `package-lock.json`: він сформований автоматично для роботи системи, з відомостями про встановлені пакунки та їх залежності.

### Використання nodemon

Для внесення змінних у виконавчу програму приходиться її зупиняти і запускати заново. Пакунок `nodemon` , який був встановлений дає можливість вносити зміни без перезапуску. Цей пакунок запускає застосунок та слідкує за зміною JS файлів. Як тільки файл змінюється - nodemon автоматично перезапускає проект.

Для можливості запуску в режимі налагодження (з nodemon) та виконання, можна використати функціональність скриптів пакунку npm. Для цього у файлі `package.json` можна записати скрипти, які будуть запускатися при виклику команди `npm run <назва скрипта>`. Також скрипти використовуються при розгортанні застосунку на кінцевому місці розташування. Так, після розгортання застосунку може використовуватися скрипт `start`, а при запуску на комп'ютері розробника - `dev`.

- [ ] Використовуючи WinSCP відкрийте файл  `package.json` змініть властивість `scripts` як це показано нижче 

```json
  "scripts": {
    "start": "node index.js",
    "dev": "nodemon index.js"
  }
```

Перший скрипт викликає звичайну команду запуску файлу `js` середовищем node.  Другий скрипт запускає модуль `nodemon`, який у свою чергу запускає `index.js` в особливому режимі. Тепер для запуску необхідного скрипта треба викликати команду `npm run <назва скрипта>`.

- [ ] Запустіть програму з використанням пакунку `nodemon`, набравши в консолі debian наступну команду

```bash
npm run dev
```

- [ ] Змініть програму в  `index.js` змінивши напис, що виводиться, у консоль виведеться нове повідомлення.
- [ ] Введіть `CTRL+C` для завершення програми.  

## Взаємодія через COM-порт

### Встановлення com0com

- [ ] Завантажте утиліту com0com https://sourceforge.net/projects/com0com/. Ця утиліта дає можливість встановлювати віртуальні COM-порти, з'єднані між собою віртуальним зв'язком. 
- [ ] Запустіть інсталятор com0com погодьтеся на всі пропозиції
- [ ] Запустіть програму setup в розділі com0com для налаштування портів. Передбачається що налаштування будуть за замовченням, а саме використання спарених портів COM4 та COM3. Закрийте вікно налаштувань.

![image-20231227141224609](media2/image-20231227141224609.png)

- [ ] Проконтролюйте, що порти з'явилися в диспетчері пристроїв комп'ютера. 

![image-20231227145728438](media2/image-20231227145728438.png)

### Встановлення та налаштування утиліти роботи з COM-портом та TCP/UDP

- [ ] Завантажте та встановіть утиліту для роботи з COM-портами (програму термінал)  а також з TCP/UDP. Надалі використовується безкоштовна утиліта Hercules, яку можна завантажити за посиланням https://www.hw-group.com/software/hercules-setup-utility Вона не потребує інсталяції
- [ ] Запустіть 2 екземпляри Hercules. При першому запуску застосунку треба дозволити доступ до апаратного забезпечення та підтвердити умови використання.
- [ ] Переключіть закладку на Serial. Налаштуйте вікно відображення в режим 16-кового відображення, спочатку `Special Chars -> Hexadecimal` а потім `HEX Enable`. Один екземпляр налаштуйте на порт COM3, а інший на COM4. Після цього натисніть `Open`
- [ ] У вікні `Send` одного з екземплярів напишіть кілька байтів у 16-ковому форматі, наприклад `01 02 03` і натисніть  кнопку `Send`. Враховуючи що порти спарені, дане посилання надішлеться на вхід іншого порту.   

![image-20231227142458190](media2/image-20231227142458190.png)

- [ ] За допомогою утиліти Hercules перевірте роботу TCP

![image-20231227151224019](media2/image-20231227151224019.png)

## 

### Налаштування віртуальної машини на роботу з послідовним портом

- [ ] При вимкненій віртуальній машині налаштуйте щоб віртуальний COM-порт комп'ютера `COM3` був прокинутий на 1-й COM-порт віртуальної машини 

![image-20231227195419816](media2/image-20231227195419816.png)

Для Devian 1-й COM-порт має назву пристрою `/dev/ttyS0`.

- [ ] Запустіть віртуальну машину. Після логування змініть налаштування порта  `/dev/ttyS0` щоб був доступ для читання та запису.

```
sudo chmod o+rw /dev/ttyS0
```

- [ ] Введіть повторно пароль адміна.
- [ ] Перевірте, що права надалися

```
ls -l /dev/ttyS0
```

Якщо права надалися, Ви отримаєте відповідь `-crw-rw-rw-`

![image-20231227201108097](media2/image-20231227201108097.png)

- [ ] Запустіть на хостовій машині утиліту для роботи з COM-портом. Підключіться до COM4. Враховуючи, що він віртуально з'єднаний з COM3, ви отримаєте зв'язок з  `/dev/ttyS0` на ВМ.

- [ ] На ВМ запустіть команду виведення тексту у вказаний пристрій

```
echo '123' > /dev/ttyS0
```

- [ ] У вікні виведення утиліти на хостовій машині Ви повинні побачити результат 

![image-20231227201917994](E:\san\AKIT\ДИСЦИП\Скриптові мови в Інтернеті речей\gitver\lab\media2\image-20231227201917994.png)

- [ ] Запустіть команду вводу з вказаного пристрою:

```
cat -v < /dev/ttyS0
```

- [ ] У утиліті відправте команду 

```
456$0d$0a
```

Останні символи відправляються в 16-ковому форматі для сигналізування завершення передачі.

![image-20231227204716603](media2/image-20231227204716603.png)

- [ ] Вийдіть з режиму приймання повідомлень за допомогою комбінації `ctrl+ C` 

Зміни прав доступу (`chmod`) не зберігаються після перезавантаження системи. Щоб зробити ці зміни стали постійними, можна використовувати `udev` правила для присвоєння дозволів пристрою (`ttyS0` у нашому випадку) при завантаженні системи. Для збереження змін налаштувань доступу до порту, необхідно зробити наступні команди.

- [ ] Створіть файл правил `ttyS0.rules` (назва може бути будь-якою) у каталозі `/etc/udev/rules.d/`:

```
sudo nano /etc/udev/rules.d/ttyS0.rules
```

- [ ] Вставте наступний рядок в цей файл:

```
KERNEL=="ttyS0", MODE="0666"
```

- [ ] Збережіть файл `CTRL+X` після чого `Y`

Це правило надасть повний доступ (`rw-rw-rw-` або `0666`) до пристрою `ttyS0` всім користувачам при кожному завантаженні системи.

- [ ] Після збереження файлу `ttyS0.rules`, перезавантажте систему:

```
sudo reboot
```

- [ ] Після цього, перевірте, чи залишилися зміни прав доступу до `/dev/ttyS0` після перезавантаження.

```
ls -l /dev/ttyS0
```

### Створення проекту node.js для прослуховування COM-порта

https://serialport.io/docs/10.x.x/api-serialport

- [ ] У консолі Debian встановіть пакунок `serialport`. Для цього у папці проекту запустіть команду

```
npm install serialport@10.5.0
```

- [ ] Використовуючи WinSCP створіть в папці проекту файл `serial.js`. Запишіть туди наступний фрагмент коду і збережіть його.

```js
const {SerialPort, ReadlineParser } = require('serialport');
const port = new SerialPort({
	path: '/dev/ttyS0',
    baudRate: 9600
});
// створення парсера, що орієнтується на розмежувач \n (0A) 
const parser = new ReadlineParser();
// парсер ставить в поток пілся отримання даних портом
port.pipe(parser);
// коли отримали рядок запускається функція зворотного виклику
parser.on('data', (data)=> {
	console.log(data);
	port.write ('I recive ' + data + ' ');
});
// відправка даних на порт напочатку
port.write(' Hello! \n');
```

- [ ] У консолі Debian запустіть команду `node serial`. 
- [ ] Запустіть утиліту Hercules , підключіться до `COM4` відправте якесь текстове повідомлення, яке завершується на символ кінця рядку, наприклад

```
Hello gateway $0A
```

Ви повинні отримати в консолі Debian відповідний текст, натомість в Hercules має прийти відповідь.

- [ ] У консолі Debian натисніть`Ctrl+c` для завершення роботи скрипта.



**Це завдання лабоараторної роботи ще не завершене!**



https://adilmoujahid.com/posts/2015/07/practical-introduction-iot-arduino-nodejs-plotly/
